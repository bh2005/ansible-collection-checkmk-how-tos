- name: Checkout repository
  uses: actions/checkout@v4
  with:
    fetch-depth: 0

- name: Set up Python
  uses: actions/setup-python@v5
  with:
    python-version: '3.10'

- name: Install dependencies
  run: |
    python -m pip install --upgrade pip
    pip install --no-cache-dir pyyaml translators pysocks colorlog

- name: Read config.yml
  run: |
    if [ -f .github/config.yml ]; then
      echo "Using existing config.yml"
    else
      echo "::error::config.yml not found"
      exit 1
    fi

- name: Clone Free-Markdown-Translator
  run: |
    git clone https://github.com/CrazyMayfly/Free-Markdown-Translator.git

- name: Verify Free-Markdown-Translator
  run: |
    if [ -f Free-Markdown-Translator/src/MarkdownTranslator.py ]; then
      echo "Free-Markdown-Translator MarkdownTranslator.py found"
      ls -l Free-Markdown-Translator/src/
    else
      echo "::error::Free-Markdown-Translator MarkdownTranslator.py not found"
      exit 1
    fi

- name: Install Free-Markdown-Translator (as a Python package)
  run: |
    cd Free-Markdown-Translator
    python -m pip install -e .

- name: Create wrapper script
  run: |
    echo "Creating wrapper script..."
    cat > translate.py << 'EOF'
    import os
    import yaml
    import sys
    from argparse import Namespace
    from MarkdownTranslator import MdTranslater

    def main():
        config_path = '.github/config.yml'
        with open(config_path, 'r', encoding='utf-8') as f:
            config = yaml.safe_load(f)
        
        args = Namespace(**config)
        translator = MdTranslater(args)
        translator.run()

    if __name__ == "__main__":
        main()
    EOF

- name: Run translation
  run: |
    python translate.py

- name: Commit and push changes
  id: commit_changes
  run: |
    git config --global user.name "GitHub Actions Bot"
    git config --global user.email "github-actions-bot@users.noreply.github.com"
    git add DEV/
    if git diff --cached --quiet; then
      echo "No changes to commit"
    else
      echo "Changes detected, committing..."
      git commit -m "Auto-translated: DEâ†’EN/FR/SP [skip ci]"
      git push
    fi

- name: Post-translation cleanup
  if: always()
  run: |
    echo "Workflow completed with status: ${{ job.status }}"
    if [ "${{ job.status }}" = "success" ]; then
      echo "Translation successful"
    else
      echo "::warning::Translation workflow had issues"
    fi
